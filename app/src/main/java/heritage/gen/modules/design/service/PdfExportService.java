package heritage.gen.modules.design.service;

import com.itextpdf.kernel.colors.ColorConstants;
import com.itextpdf.kernel.colors.DeviceRgb;
import com.itextpdf.kernel.font.PdfFont;
import com.itextpdf.kernel.font.PdfFontFactory;
import com.itextpdf.kernel.geom.PageSize;
import com.itextpdf.kernel.pdf.PdfDocument;
import com.itextpdf.kernel.pdf.PdfWriter;
import com.itextpdf.layout.Document;
import com.itextpdf.layout.element.Image;
import com.itextpdf.layout.element.Paragraph;
import com.itextpdf.layout.properties.HorizontalAlignment;
import com.itextpdf.layout.properties.TextAlignment;
import com.itextpdf.layout.properties.UnitValue;
import heritage.gen.modules.design.model.ArtifactEntity;
import lombok.extern.slf4j.Slf4j;
import org.springframework.core.io.ClassPathResource;
import org.springframework.stereotype.Service;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.net.URI;

@Slf4j
@Service
public class PdfExportService {

    private static final DeviceRgb PRIMARY_COLOR = new DeviceRgb(139, 69, 19);

    public byte[] generateDesignPdf(ArtifactEntity entity) {
        try (ByteArrayOutputStream baos = new ByteArrayOutputStream()) {
            PdfWriter writer = new PdfWriter(baos);
            PdfDocument pdf = new PdfDocument(writer);
            Document document = new Document(pdf, PageSize.A4);
            document.setMargins(40, 40, 40, 40);

            PdfFont font = loadChineseFont();

            Paragraph title = new Paragraph(entity.getDesignName())
                    .setFont(font)
                    .setFontSize(24)
                    .setFontColor(PRIMARY_COLOR)
                    .setTextAlignment(TextAlignment.CENTER)
                    .setBold();
            document.add(title);

            document.add(new Paragraph("\n"));

            if (entity.getProductShotUrl() != null && !entity.getProductShotUrl().isBlank()) {
                try {
                    byte[] imgData = downloadImage(entity.getProductShotUrl());
                    if (imgData != null) {
                        Image productImg = new Image(com.itextpdf.io.image.ImageDataFactory.create(imgData));
                        productImg.setWidth(UnitValue.createPercentValue(60));
                        productImg.setHorizontalAlignment(HorizontalAlignment.CENTER);
                        document.add(productImg);
                    }
                } catch (Exception e) {
                    log.warn("产品图片下载失败", e);
                }
            }

            document.add(new Paragraph("\n"));

            addSection(document, "设计理念", entity.getDesignConcept(), font);

            if (entity.getConceptData() != null) {
                String culturalContext = (String) entity.getConceptData().get("culturalContext");
                if (culturalContext != null) {
                    addSection(document, "文化溯源", culturalContext, font);
                }

                String dimensions = (String) entity.getConceptData().get("dimensions");
                String formFactor = (String) entity.getConceptData().get("formFactor");
                String userInteraction = (String) entity.getConceptData().get("userInteraction");

                if (formFactor != null) {
                    addSection(document, "形态规格", formFactor + "\n尺寸: " + dimensions, font);
                }
                if (userInteraction != null) {
                    addSection(document, "交互体验", userInteraction, font);
                }

                var materials = entity.getConceptData().get("materials");
                if (materials != null) {
                    addSection(document, "材质工艺", materials.toString(), font);
                }

                var colors = entity.getConceptData().get("colors");
                if (colors != null) {
                    addSection(document, "色彩方案", colors.toString(), font);
                }

                var keyFeatures = entity.getConceptData().get("keyFeatures");
                if (keyFeatures != null) {
                    addSection(document, "核心功能点", keyFeatures.toString(), font);
                }
            }

            document.add(new Paragraph("\n\n"));
            Paragraph footer = new Paragraph("Generated by Heritage Culture AI Design")
                    .setFont(font)
                    .setFontSize(10)
                    .setFontColor(ColorConstants.GRAY)
                    .setTextAlignment(TextAlignment.CENTER);
            document.add(footer);

            document.close();
            return baos.toByteArray();

        } catch (Exception e) {
            log.error("PDF生成失败", e);
            throw new RuntimeException("PDF生成失败: " + e.getMessage(), e);
        }
    }

    private PdfFont loadChineseFont() throws IOException {
        // Windows系统字体路径 (ttc文件需要指定索引)
        String[] windowsFonts = {
            "C:/Windows/Fonts/msyh.ttc,0",   // 微软雅黑
            "C:/Windows/Fonts/simsun.ttc,0", // 宋体
            "C:/Windows/Fonts/simhei.ttf"    // 黑体
        };
        
        // Linux/Mac系统字体路径
        String[] unixFonts = {
            "/usr/share/fonts/truetype/noto/NotoSansSC-Regular.ttf",
            "/System/Library/Fonts/PingFang.ttc"
        };
        
        String os = System.getProperty("os.name").toLowerCase();
        String[] fontPaths = os.contains("win") ? windowsFonts : unixFonts;
        
        for (String fontPath : fontPaths) {
            try {
                String actualPath = fontPath.split(",")[0];
                java.io.File fontFile = new java.io.File(actualPath);
                if (fontFile.exists()) {
                    PdfFont font = PdfFontFactory.createFont(
                        fontPath, 
                        com.itextpdf.kernel.font.PdfFontFactory.EmbeddingStrategy.PREFER_EMBEDDED
                    );
                    log.info("成功加载系统字体: {}", fontPath);
                    return font;
                }
            } catch (Exception e) {
                log.debug("字体 {} 加载失败: {}", fontPath, e.getMessage());
            }
        }
        
        log.warn("所有中文字体加载失败，使用默认字体");
        return PdfFontFactory.createFont();
    }

    private void addSection(Document document, String title, String content, PdfFont font) {
        Paragraph titlePara = new Paragraph(title)
                .setFont(font)
                .setFontSize(14)
                .setFontColor(PRIMARY_COLOR)
                .setBold()
                .setMarginTop(15);
        document.add(titlePara);

        Paragraph contentPara = new Paragraph(content == null ? "" : content)
                .setFont(font)
                .setFontSize(11)
                .setFontColor(ColorConstants.DARK_GRAY)
                .setTextAlignment(TextAlignment.JUSTIFIED);
        document.add(contentPara);
    }

    private byte[] downloadImage(String imageUrl) {
        try {
            return URI.create(imageUrl).toURL().openStream().readAllBytes();
        } catch (Exception e) {
            log.error("图片下载失败: {}", imageUrl, e);
            return null;
        }
    }
}
